<div class="container my-5">
  <h2 class="mb-4">投稿詳細</h2>

  <!-- 投稿情報テーブル -->
  <table class="table table-bordered table-striped">
    <tbody>
      <tr>
        <th scope="row" style="width: 20%;">タイトル</th>
        <td><%= @post.title %></td>
      </tr>
      <tr>
        <th scope="row">カテゴリ</th>
        <td><%= @post.category&.name || "なし" %></td>
      </tr>
      <tr>
        <th scope="row">投稿者</th>
        <td><%= @post.user.full_name %></td>
      </tr>
      <tr>
        <th scope="row">本文</th>
        <td>
          <%= simple_format(@post.body) %>
          <div class="mt-3">
            <div id="favorite_btn_<%= @post.id %>">
              <%= render "public/favorites/btn", post: @post %>
            </div>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- 画像表示 -->
  <% if @post.images.attached? %>
    <div class="row mb-4">
      <% @post.images.each_with_index do |img, index| %>
        <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
          <%= image_tag img.variant(resize:'400x400'), class: "w-100 rounded shadow-sm clickable-image", alt: @post.title, data: { toggle: "modal", target: "#imageModal", "img-url": url_for(img) } %>
          <i class="fas fa-search position-absolute" style="bottom:8px; right:8px; color:white; text-shadow:0 0 5px black; cursor:pointer;" data-toggle="modal" data-target="#imageModal" data-img-url="<%= url_for(img) %>"></i>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- 画像拡大モーダル -->
  <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
      <div class="modal-content bg-transparent border-0 position-relative p-0">
        <button type="button" class="position-absolute border-0 bg-transparent text-white"
                data-dismiss="modal"
                style="top:-30px; right:-30px; z-index:1051; font-size:2rem; cursor:pointer;">
          ❌
        </button>
        <div class="modal-body p-0">
          <img src="" class="img-fluid" id="modalImage" alt="拡大画像">
        </div>
      </div>
    </div>
  </div>

  <!-- 編集/削除ボタン（投稿者のみ） -->
  <% if @post.user == current_user %>
    <div class="mb-4">
      <%= link_to "編集", edit_public_post_path(@post), class: "btn btn-outline-primary mr-2" %>
      <%= link_to "削除", public_post_path(@post), method: :delete,
                  "data-confirm" => "本当に削除しますか？", class: "btn btn-outline-danger" %>
    </div>
  <% end %>

  <!-- 投稿一覧ボタンと通報ボタンを右上配置 -->
  <div class="d-flex justify-content-between mb-4">
    <%= link_to "投稿一覧に戻る", about_path, class: "btn btn-success" %>

    <% if user_signed_in? && current_user != @post.user %>
      <div class="ml-2">
        <% if current_user.reports.exists?(post_id: @post.id) %>
          <% report = current_user.reports.find_by(post_id: @post.id) %>
          <button class="btn btn-secondary" type="button" data-toggle="collapse" data-target="#reportDetails" aria-expanded="false">
            通報済み
          </button>
          <% else %>
          <button class="btn btn-danger" type="button" data-toggle="collapse" data-target="#newReportForm" aria-expanded="false">
            通報
          </button>
        <% end %>
      </div>
    <% end %>
  </div>
  <% if user_signed_in? && current_user != @post.user %>
    <% if current_user.reports.exists?(post_id: @post.id) %>
      <% report = current_user.reports.find_by(post_id: @post.id) %>
      <div class="collapse mt-2" id="reportDetails">
        <div class="card card-body">
          <p><strong>通報理由：</strong></p>
          <p><%= simple_format(report.reason) %></p>
          <p><strong>通報日時：</strong> <%= report.created_at.strftime("%Y/%m/%d %H:%M") %></p>
          <%= button_to "通報を取り消す", public_post_report_path(@post, report), method: :delete, data: { confirm: "通報を取り消しますか？" }, class: "btn btn-danger btn-block mt-2" %>
        </div>
      </div>
    <% else %>
      <div class="collapse mt-2" id="newReportForm">
        <div class="card card-body">
          <%= form_with model: [:public, @post, Report.new], local: true do |f| %>
            <div class="form-group">
              <%= f.label :reason, "通報理由" %>
              <%= f.text_area :reason, class: "form-control", rows: 4, placeholder: "例: 不適切な内容が含まれています" %>
            </div>
            <%= f.submit "通報を送信", class: "btn btn-danger btn-block mt-2" %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>


  <!-- コメントセクション -->
  <div class="d-flex align-items-center mb-3 mt-4">
    <h3 class="mb-0">コメント</h3>
    <i class="fa-slab fa-regular fa-comment fa-bounce fa-xl ml-2"></i>
    <h4 class="text-muted ml-2"><%= @post.comments.size %>件</h4>
  </div>

  <% if @comment && @comment.errors.any? %>
    <div class="alert alert-danger">
      <ul class="mb-0">
        <% @comment.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form_with(model: [@post, @comment || Comment.new], url: public_post_comments_path(@post), local: true, class: "mb-4") do |f| %>
    <div class="form-group">
      <%= f.text_area :content, rows: 3, placeholder: "コメントを入力してください", class: "form-control" %>
    </div>
    <%= f.submit "コメントを投稿", class: "btn btn-primary" %>
  <% end %>

  <div class="mt-4">
    <% @post.comments.includes(:user).order(created_at: :desc).each do |comment| %>
      <div class="card mb-2">
        <div class="card-body d-flex p-2">
          <div class="me-2">
            <i class="fa-slab fa-regular fa-circle-user fa-xl" style="color: #cc870f;"></i>
          </div>
          <div>
            <strong><%= comment.user.last_name %>:</strong>
            <p class="mb-1"><%= comment.content %></p>
            <% if comment.user == current_user %>
              <i class="fa-solid fa-eraser fa-beat-fade"></i>
              <%= link_to "削除", public_post_comment_path(@post, comment),
                          method: :delete,
                          data: { confirm: "削除しますか？" },
                          class: "btn btn-sm btn-outline-danger" %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
